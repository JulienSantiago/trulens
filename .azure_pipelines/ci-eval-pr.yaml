pr:
  branches:
    include:
      - main
      - releases/*
  paths:
    include:
      - trulens_eval

jobs:
  - job: branchtest
    pool:
      vmImage: ubuntu-latest
    timeoutInMinutes: 30

    strategy:
      matrix:
        latest:
          python-version: 3.11
          tests-folder: tests/unit
        py308:
          python-version: 3.8
          tests-folder: tests/unit/static
        py309:
          python-version: 3.9
          tests-folder: tests/unit/static
        py310:
          python-version: 3.10
          tests-folder: tests/unit/static
        py311:
          python-version: 3.11
          tests-folder: tests/unit/static

    #env:
    #  OPENAI_API_KEY: $(OPENAI_API_KEY)
    #  HUGGINGFACE_API_KEY: $(HUGGINGFACE_API_KEY)
    #  PINECONE_API_KEY: $(PINECONE_API_KEY)
    #  PINECONE_ENV: $(PINECONE_ENV)
    #  HUGGINGFACEHUB_API_TOKEN: $(HUGGINGFACEHUB_API_TOKEN)

    steps:
      - checkout: self
        clean: true

      - name: Add conda to PATH
        bash: echo "##vso[task.prependpath]$CONDA/bin"

      - name: Create Anaconda environment with python=$(python-version)
        bash: |
          set -e
          conda create -y --quiet \
            -n $(python-version) \
            python=$(python-version)

          conda init bash

      - name: Format Code
        # condition: ${{ eq(python-version, "3.11") }} # only run format check with latest python version
        bash: |
          set -e
          source activate $(python-version)

          pip install yapf==0.32.0
          pip install isort==5.10.1

          yapf --version
          isort --vn

          ./format.sh --eval

      - name: NoDiffCheck
        bash: |
          num_changed_files=`git ls-files --others -m --exclude-standard ./trulens_eval | wc -l`
          if [ $num_changed_files -ne 0 ]; then
            echo "The following files have changed after running format.sh. Please format your code and update the PR."
            git ls-files --others -m --exclude-standard ./trulens_eval
            echo "\n\nOutputting git diff for checked in files.\n"
            git diff
          fi

      - name: Install trulens
        bash: |
          set -e
          source activate $(python-version)

          cd ./trulens_eval
          pip install -e .

          python --version
          pip --version
          pip list

      - name: Install testing packages
        bash: |
          set -e
          source activate $(python-version)

          pip install ipykernel
          pip install pytest==7.0.1 pytest-azurepipelines

          python -m ipykernel install --user \
            --name $(python-version) \
            --display-name $(python-version)

      - name: Unit tests
        bash: |
          source activate $(python-version)

          cd ./trulens_eval
          python -m pytest $(tests-folder)

      - name: Install optional packages
        bash: |
          set -e
          source activate $(python-version)

          cd ./trulens_eval

          pip install -r trulens_eval/requirements.optional.txt

          python --version
          pip --version
          pip list

      - name: Unit tests with optional packages
        bash: |
          set -e
          source activate $(python-version)

          cd ./trulens_eval

          python -m pytest $(tests-folder)
